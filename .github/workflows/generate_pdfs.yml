name: Generate PDFs from CSV

on:
  workflow_dispatch:
    inputs:
      csv_url:
        description: 'CSV File URL'
        required: true
        default: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTBuDewVgTDoc_zaWYQyaWKpBt0RwtFPhnBrpqr1v6Y5wfAmPpEYvTsaWd64bsHhH68iYNtLMSRpOQ0/pub?gid=113399134&single=true&output=csv'
        type: string
      start_row:
        description: 'Start Row Number (1-based)'
        required: true
        default: '48'
        type: string
      end_row:
        description: 'End Row Number (1-based)'
        required: true
        default: '53'
        type: string

jobs:
  generate-pdfs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas fpdf2 requests
    
    - name: Create PDFs directory
      run: mkdir -p pdfs
    
    - name: Generate PDFs from CSV
      run: |
        python scripts/generate_pdfs.py \
          --csv-url "${{ github.event.inputs.csv_url }}" \
          --output-dir pdfs \
          --start-row ${{ github.event.inputs.start_row }} \
          --end-row ${{ github.event.inputs.end_row }}
    
    - name: Create ZIP of PDFs
      run: |
        cd pdfs
        zip -r ../pdfs.zip *.pdf summary.txt
        cd ..
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: pdfs-${{ github.run_number }}
        release_name: "PDFs for Rows ${{ github.event.inputs.start_row }}-${{ github.event.inputs.end_row }}"
        body: |
          ## PDF Generation Summary
          
          - **Source:** CSV from Google Sheets
          - **Rows processed:** ${{ github.event.inputs.start_row }} to ${{ github.event.inputs.end_row }}
          - **Generated:** ${{ github.event.repository.updated_at }}
          
          ### Files Generated:
          $(ls pdfs/*.pdf | xargs -n1 basename | sed 's/^/- /')
        draft: false
        prerelease: false
    
    - name: Upload PDFs to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./pdfs.zip
        asset_name: pdfs_rows_${{ github.event.inputs.start_row }}_to_${{ github.event.inputs.end_row }}.zip
        asset_content_type: application/zip
    
    - name: Upload PDFs as Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: generated-pdfs-rows-${{ github.event.inputs.start_row }}-to-${{ github.event.inputs.end_row }}
        path: pdfs/
        retention-days: 30
    
    - name: Commit PDFs to Repository (Optional)
      if: false
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add pdfs/*.pdf pdfs/summary.txt
        git commit -m "Add generated PDFs for rows ${{ github.event.inputs.start_row }}-${{ github.event.inputs.end_row }} [skip ci]" || exit 0
        git push
